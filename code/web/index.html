<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Financial Advisor Bot (Demo)</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <div class="container">
    <div class="title">Financial Advisor Bot</div>
    <div class="subtitle">Decisions are based on the latest available dataset date.</div>

    <div class="query-row">
      <input id="q" type="text" placeholder='Try: "Should I buy Apple stocks?"' />
      <button id="askBtn">Ask</button>
    </div>

    <div class="chips">
      <button class="chip" type="button" data-q="Which company shares should I buy today?">Top picks today</button>
      <button class="chip" type="button" data-q="Should I buy Apple stocks?">Buy Apple?</button>
      <button class="chip" type="button" data-q="Should I sell nvidia?">Sell Nvidia?</button>
    </div>

    <div id="out"></div>
  </div>

  <script>
    const out = document.getElementById("out");
    const input = document.getElementById("q");
    const askBtn = document.getElementById("askBtn");

    function esc(s) {
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    function actionBadgeClass(action){
      const a = String(action || "").toUpperCase();
      if (a === "BUY") return "badge buy";
      if (a === "SELL") return "badge sell";
      return "badge hold";
    }

    function pct(p){
      const v = Math.max(0, Math.min(1, Number(p || 0)));
      return Math.round(v * 100);
    }

    function formatNum(x, digits){
      const n = Number(x);
      if (!Number.isFinite(n)) return "—";
      return n.toFixed(digits);
    }

    async function ask(question) {
      const q = String(question || "").trim();
      if (!q) return;

      askBtn.disabled = true;
      out.innerHTML = `<div class="toast">Calling API…</div>`;

      let res, data;
      try{
        res = await fetch("/ask", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({question: q, top_k: 3})
        });
        data = await res.json();
      } catch (e){
        out.innerHTML = `<div class="toast error"><b>Network error.</b> ${esc(e)}</div>`;
        askBtn.disabled = false;
        return;
      }

      askBtn.disabled = false;

      if (!res.ok) {
        out.innerHTML = `<div class="toast error"><b>Error:</b> ${esc(JSON.stringify(data))}</div>`;
        return;
      }

      const header = `
        <div class="card">
          <div class="row-split">
            <div>
              <div style="font-weight:800; font-size:14px;">Intent: ${esc(data.intent || "")}</div>
              <div class="meta"><strong>Used date:</strong> ${esc(data.used_date || "")}</div>
            </div>
          </div>
          ${data.note ? `<div class="inline-note">${esc(data.note)}</div>` : ""}
        </div>
      `;

      const decisions = (data.decisions || []).map(d => {
        const conf = Number(d.confidence || 0);
        const confPct = pct(conf);

        return `
          <div class="card">
            <div class="card-head">
              <div>
                <div class="ticker">
                  <span>${esc(d.ticker)}</span>
                  ${d.company ? `<span class="company">(${esc(d.company)})</span>` : ""}
                </div>
                <div class="date">Date: ${esc(d.date || "")}</div>
              </div>
              <span class="${actionBadgeClass(d.action)}">${esc(d.action || "HOLD")}</span>
            </div>

            <div class="card-body">
              <div class="stat">
                <div class="label">Confidence</div>
                <div class="value">${formatNum(conf, 4)}</div>
                <div class="bar"><div style="width:${confPct}%"></div></div>
              </div>

              <div class="stat">
                <div class="label">Decision margin (q_gap)</div>
                <div class="value">${formatNum(d.q_gap, 6)}</div>
                <div class="bar"><div style="width:${Math.min(100, Math.round(Number(d.q_gap || 0) * 10000))}%"></div></div>
              </div>
            </div>
          </div>
        `;
      }).join("");

      out.innerHTML = `
        ${header}
        <div class="grid">
          ${decisions || `<div class="card">No decisions returned.</div>`}
        </div>
        <details class="card">
          <summary><b>Raw JSON</b></summary>
          <pre>${esc(JSON.stringify(data, null, 2))}</pre>
        </details>
      `;
    }

    askBtn.addEventListener("click", () => ask(input.value));
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") ask(input.value);
    });

    document.querySelectorAll("button[data-q]").forEach(btn => {
      btn.addEventListener("click", () => {
        input.value = btn.dataset.q;
        ask(input.value);
      });
    });
  </script>
</body>
</html>